!function(L){var DEG_TO_RAD=Math.PI/180;L.Ellipse=L.Path.extend({initialize:function(latlng,radii,tilt,options){L.setOptions(this,options),this.setLatLng(latlng),this._tiltDeg=tilt?tilt:0,radii&&(this._mRadiusX=radii[0],this._mRadiusY=radii[1]),this._bounds=this.getBounds()},options:{ellipse:!0,fill:!0,startAngle:0,endAngle:359.9},setLatLng:function(latlng){return this._latlng=L.latLng(latlng),this.redraw()},setRadius:function(radii){return this._mRadiusX=radii[0],this._mRadiusY=radii[1],this.redraw()},setTilt:function(tilt){return this._tiltDeg=tilt,this.redraw()},_project:function(){this._point=this._map.latLngToLayerPoint(this._latlng),this._projectLatlngs();var w=this._clickTolerance(),p=new L.Point(w,-w);this._bounds.isValid()&&(this._pxBounds=new L.Bounds(this._map.latLngToLayerPoint(this._bounds.getSouthWest())._subtract(p),this._map.latLngToLayerPoint(this._bounds.getNorthEast())._add(p)))},_projectLatlngs:function(){var lngRadius=this._getLngRadius(),latRadius=this._getLatRadius(),latlng=this._latlng,pointLeft=this._map.latLngToLayerPoint([latlng.lat,latlng.lng-lngRadius]),pointBelow=this._map.latLngToLayerPoint([latlng.lat-latRadius,latlng.lng]);this._point=this._map.latLngToLayerPoint(latlng),this._radiusX=Math.max(this._point.x-pointLeft.x,1),this._radiusY=Math.max(pointBelow.y-this._point.y,1),this._endPointParams=this._centerPointToEndPoint()},getBounds:function(){var lngRadius=this._getLngRadius(),latRadius=this._getLatRadius(),latlng=this._latlng;return new L.LatLngBounds([latlng.lat-latRadius,latlng.lng-lngRadius],[latlng.lat+latRadius,latlng.lng+lngRadius])},getLatLng:function(){return this._latlng},getPathString:function(){var c=this._point,rx=this._radiusX,ry=this._radiusY,phi=this._tiltDeg,endPoint=this._endPointParams;return this._checkIfEmpty()?"":L.Browser.svg?"M"+endPoint.x0+","+endPoint.y0+"A"+rx+","+ry+","+phi+","+endPoint.largeArc+","+endPoint.sweep+","+endPoint.x1+","+endPoint.y1+" z":(c._round(),rx=Math.round(rx),ry=Math.round(ry),"AL "+c.x+","+c.y+" "+rx+","+ry+" "+phi+",23592600")},getRadius:function(){return new L.point(this._mRadiusX,this._mRadiusY)},_update:function(){this._map&&this._renderer._updatePoly(this,this.getPathString())},_empty:function(){return this._radius&&!this._renderer._bounds.intersects(this._pxBounds)},_centerPointToEndPoint:function(){var c=this._point,rx=this._radiusX,ry=this._radiusY,theta2=(this.options.startAngle+this.options.endAngle)*DEG_TO_RAD,theta1=this.options.startAngle*DEG_TO_RAD,delta=this.options.endAngle,phi=this._tiltDeg*DEG_TO_RAD,x0=c.x+Math.cos(phi)*rx*Math.cos(theta1)+Math.sin(-phi)*ry*Math.sin(theta1),y0=c.y+Math.sin(phi)*rx*Math.cos(theta1)+Math.cos(phi)*ry*Math.sin(theta1),x1=c.x+Math.cos(phi)*rx*Math.cos(theta2)+Math.sin(-phi)*ry*Math.sin(theta2),y1=c.y+Math.sin(phi)*rx*Math.cos(theta2)+Math.cos(phi)*ry*Math.sin(theta2),largeArc=delta>180?1:0,sweep=delta>0?1:0;return{x0:x0,y0:y0,tilt:phi,largeArc:largeArc,sweep:sweep,x1:x1,y1:y1}},_getLatRadius:function(){return this._mRadiusY/40075017*360},_getLngRadius:function(){return this._mRadiusX/40075017*360/Math.cos(DEG_TO_RAD*this._latlng.lat)},_updatePathViewport:function(){var p=L.Path.CLIP_PADDING,size=this._map.getSize(),panePos=L.DomUtil.getPosition(this._map._mapPane),min=panePos.multiplyBy(-1)._subtract(size.multiplyBy(p)._round()),max=min.add(size.multiplyBy(1+2*p)._round());this._pathViewport=new L.Bounds(min,max)},_checkIfEmpty:function(){if(!this._map)return!1;this._updatePathViewport();var vp=this._pathViewport,r=this._radiusX,p=this._point;return p.x-r>vp.max.x||p.y-r>vp.max.y||p.x+r<vp.min.x||p.y+r<vp.min.y}});var originalSVGUpdatePoly=L.SVG.prototype._updatePoly,originalCanvasUpdatePoly=L.Canvas.prototype._updatePoly;L.SVG.include({_updatePoly:function(layer,closed){return layer._parts&&"undefined"==typeof layer.options.ellipse?originalSVGUpdatePoly.call(this,layer,closed):void this._setPath(layer,closed)}}),L.Canvas.include({_updatePoly:function(layer,closed){"undefined"==typeof layer.options.ellipse&&originalCanvasUpdatePoly(layer,closed)}}),L.ellipse=function(latlng,radii,tilt,options){return new L.Ellipse(latlng,radii,tilt,options)}}(L);